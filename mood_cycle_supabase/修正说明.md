# 涨停数据修正说明

## 📋 修正概览

根据您的反馈，对**涨停数量、溢价、红盘率、晋级率**等核心指标进行了全面修正。

---

## 🔧 修正内容

### 1. 数据获取方式修正 ✅

**修改前：**
```python
# 分3次调用API
limit_up_df = pro.limit_list_d(trade_date=date, limit_type='U')    # 涨停
limit_down_df = pro.limit_list_d(trade_date=date, limit_type='D')  # 跌停
break_board_df = pro.limit_list_d(trade_date=date, limit_type='Z') # 炸板
```

**修改后：**
```python
# 一次性获取所有数据，通过limit字段区分
limit_data = pro.limit_list_d(trade_date=date)  # limit字段：U/D/Z
```

**优势：**
- ✅ 减少API调用次数（3次→1次）
- ✅ 数据一致性更好
- ✅ 获取更多字段：`limit_amount`, `float_mv`, `total_mv`, `turnover_ratio`, `first_time`, `last_time`

---

### 2. 涨停数量统计修正 ✅

**问题：**
- 之前只统计了`limit_type='U'`的涨停股票
- 遗漏了炸板(`limit_type='Z'`)的股票

**修正：**
```python
# 涨停数 = limit='U'的股票（最终封板）
# 炸板数 = limit='Z'的股票（曾涨停但打开）
# 总计涨停尝试 = 涨停数 + 炸板数
```

**数据对比（2026-01-27）：**
- 涨停：53只
- 炸板：18只
- 炸板率：25.35%

---

### 3. 红盘率定义修正 ⚠️ **重要**

**修改前（错误）：**
```python
red_count = len(df[df['close'] >= df['open']])  # 收盘≥开盘
```

**问题：**
- 对涨停股来说，收盘价通常都是涨停价
- 即使低开，收盘也是涨停价，导致红盘率虚高（接近100%）
- **不符合市场"红盘"的真实含义**

**修改后（正确）：**
```python
red_count = len(df[df['open'] >= df['pre_close']])  # 开盘≥昨收
```

**说明：**
- ✅ 红盘：指开盘价高于或等于前收盘价
- ✅ 更符合市场习惯
- ✅ 反映真实的市场情绪

**数据对比（2026-01-26）：**
- 修改前：首板红盘率 ~100%（虚高）
- 修改后：首板红盘率 96.4%（合理）

---

### 4. 晋级率定义修正 ⚠️ **重要**

**修改前（错误）：**
```python
# 1进2：昨日首板且今日二板的股票 / 昨日首板总数
yesterday_1b = 昨日limit_times=1的股票
today_2b = 今日limit_times=2的股票
advance_1to2 = len(yesterday_1b & today_2b) / len(yesterday_1b)
```

**问题：**
- ❌ 只统计了"精确晋级到N+1板"的股票
- ❌ 遗漏了"昨日首板，今日三板或更高"的情况
- ❌ 不符合"晋级"的真实含义（继续涨停就是晋级）

**修改后（正确）：**
```python
# 1进2：昨日首板，今日任意涨停的股票 / 昨日首板总数
yesterday_1b = 昨日limit_times=1的股票
today_all_limit = 今日所有涨停股票（不限几板）
advance_1to2 = len(yesterday_1b & today_all_limit) / len(yesterday_1b)
```

**说明：**
- ✅ 晋级 = 昨日涨停，今日继续涨停（不管几板）
- ✅ 更准确反映"连板续涨"的能力
- ✅ 符合市场实际情况

**案例对比（2026-01-26）：**
- 修改前逻辑：1进2 = 0%（因为没有恰好晋级到2板的）
- 修改后逻辑：1进2 = 0%（确实没有昨日首板今日继续涨停的）

---

### 5. 新增"昨日涨停今日表现"指标 🆕

**新增6个指标：**

| 指标 | 说明 |
|------|------|
| `yesterday_first_premium` | 昨日首板股票，今日平均涨幅 |
| `yesterday_first_red_rate` | 昨日首板股票，今日开盘红盘率 |
| `yesterday_second_premium` | 昨日二板股票，今日平均涨幅 |
| `yesterday_second_red_rate` | 昨日二板股票，今日开盘红盘率 |
| `yesterday_third_premium` | 昨日三板以上股票，今日平均涨幅 |
| `yesterday_third_red_rate` | 昨日三板以上股票，今日开盘红盘率 |

**用途：**
- 追踪连板股票次日的走势
- 判断市场对连板股的认可度
- 辅助决策是否参与连板股

**数据示例（2026-01-26）：**
- 昨日首板今日红盘率：61.5%
- 昨日首板今日溢价：-1.50%（次日平均跌1.5%）
- 昨日二板今日红盘率：100%
- 昨日二板今日溢价：11.12%（次日平均涨11.12%）

---

## 📊 指标对比总结

### 当日涨停板指标
- `first_red_rate` - 今日首板开盘红盘率（开盘≥昨收）
- `first_premium` - 今日首板平均涨幅
- `second_red_rate` - 今日二板开盘红盘率
- `second_premium` - 今日二板平均涨幅

### 昨日涨停今日表现（新增）
- `yesterday_first_premium` - 昨日首板今日平均涨幅
- `yesterday_first_red_rate` - 昨日首板今日开盘红盘率
- `yesterday_second_premium` - 昨日二板今日平均涨幅
- `yesterday_second_red_rate` - 昨日二板今日开盘红盘率

### 晋级率（修正）
- `advance_1to2` - 昨日首板今日继续涨停的比例
- `advance_2to3` - 昨日二板今日继续涨停的比例
- `advance_3plus` - 昨日三板以上今日继续涨停的比例

---

## 🔍 数据验证

### 2026-01-26 数据验证结果

```
【市场概况】
  涨停: 70只 | 跌停: 30只 | 炸板: 40只 | 炸板率: 36.4%
  首板: 55只 | 二板: 14只 | 三板: 0只 | 三板以上: 1只 | 最高板: 5板

【晋级率（修正后）】
  1进2（昨日首板今日任意涨停）: 0.0%
  2进3（昨日二板今日任意涨停）: 100.0%
  3板以上（昨日3板+今日任意涨停）: 100.0%

【今日涨停板表现】
  首板红盘率（开盘≥昨收）: 96.4%
  首板溢价（平均涨幅）: 11.82%
  二板红盘率: 100.0%
  二板溢价: 10.71%

【昨日涨停今日表现（新增）】
  昨日首板今日红盘率: 61.5%
  昨日首板今日溢价: -1.50%
  昨日二板今日红盘率: 100.0%
  昨日二板今日溢价: 11.12%
```

---

## 📝 数据来源说明

### 主要数据源

1. **tushare.pro.limit_list_d()**
   - 字段：`ts_code, trade_date, industry, name, close, pct_chg, amount, limit_amount, float_mv, total_mv, turnover_ratio, fd_amount, first_time, last_time, open_times, up_stat, limit_times, limit`
   - 用途：获取涨停、跌停、炸板数据
   - 说明：`limit`字段区分类型（U=涨停，D=跌停，Z=炸板）

2. **tushare.pro.daily()**
   - 字段：`ts_code, trade_date, open, high, low, close, pre_close, pct_chg, vol, amount`
   - 用途：补充开盘价、最低价等数据
   - 说明：用于计算红盘率、反包等指标

3. **tushare.pro.daily_basic()**
   - 字段：`ts_code, trade_date, turnover_rate, volume_ratio, total_mv, circ_mv`
   - 用途：换手率、市值等基础指标

---

## ✅ 修正后的优势

1. **数据更准确**：
   - ✅ 涨停数量不再遗漏炸板
   - ✅ 红盘率反映真实的开盘情况
   - ✅ 晋级率符合市场实际定义

2. **指标更丰富**：
   - ✅ 新增昨日涨停今日表现追踪
   - ✅ 可分析连板股的延续性
   - ✅ 辅助判断市场情绪强度

3. **计算更合理**：
   - ✅ 一次性获取数据，避免遗漏
   - ✅ 红盘率用开盘价对比昨收
   - ✅ 晋级率统计所有继续涨停的股票

---

## 🚀 使用建议

1. **查看当日情绪**：
   - 关注首板红盘率、涨停数、炸板率
   - 首板红盘率高 + 炸板率低 = 情绪好

2. **评估连板持续性**：
   - 关注晋级率和昨日涨停今日表现
   - 晋级率高 + 昨日首板今日溢价正 = 连板有持续性

3. **判断市场强度**：
   - 关注首板数量、最高板、封单金额
   - 首板多 + 最高板高 + 封单强 = 市场强

---

## 📞 联系支持

如发现数据异常或有新的需求，请运行：
```bash
python verify_data.py  # 验证数据准确性
python test_system.py  # 完整系统测试
```

---

**更新时间**：2026-01-27  
**版本**：v1.1.0
