# 市场情绪周期监控系统 - 使用指南

## 系统概述

这是一个基于tushare数据的市场情绪周期可视化工具，支持每日增量更新和历史数据分析。

### 核心功能

✅ **26个核心指标**：
- 市场基础：上涨/下跌家数、涨停/跌停数、涨跌5%统计
- 连板统计：首板、二板、三板、三板以上、最高板
- 晋级率：1进2、2进3、3板以上晋级率
- 高阶指标：反包涨停、涨停金额、封单金额
- 红盘率与溢价：首板/二板/三板以上的红盘率和溢价
- 炸板统计：炸板数、炸板率

✅ **Web可视化界面**：
- 数据表格展示（类似Excel）
- 根据数值自动颜色标记（红绿标记）
- 日期范围筛选
- 表格排序功能
- Excel导出功能

✅ **数据管理**：
- Parquet高效存储
- 增量更新机制
- 历史数据补充
- 自定义时段查询

---

## 快速开始

### 1. 安装依赖

```bash
pip install -r requirements.txt
```

### 2. 初始化数据

首次运行，获取2026年至今的数据：

```bash
python update_data.py --init
```

### 3. 启动Web服务

```bash
python app.py
```

然后在浏览器访问：**http://127.0.0.1:5000**

---

## 核心操作

### 📅 每日数据更新

收盘后（建议15:30之后）运行：

```bash
python update_data.py
```

脚本会自动检测缺失的交易日并补充数据。

### 📦 补充历史数据

如需补充特定时段的历史数据：

```bash
# 补充2024年全年数据
python update_data.py --start 20240101 --end 20241231

# 补充2025年上半年数据
python update_data.py --start 20250101 --end 20250630
```

### 🌐 Web页面使用

1. **日期筛选**：
   - 点击"开始日期"和"结束日期"选择时间范围
   - 点击"查询"按钮刷新数据

2. **表格操作**：
   - 点击表头可按该列排序
   - 使用搜索框快速查找
   - 颜色含义：红色=正面指标，绿色=负面指标

3. **导出数据**：
   - 点击"导出Excel"按钮下载当前筛选的数据

---

## 指标说明

### 基础指标

| 指标 | 说明 |
|------|------|
| 上涨/下跌 | 当日涨跌家数统计 |
| 涨停/跌停 | 涨停板和跌停板数量 |
| 炸板 | 曾经涨停但最终未封住的股票 |
| 炸板率 | 炸板数 / (涨停数 + 炸板数) |

### 连板统计

| 指标 | 说明 |
|------|------|
| 首板 | 连续涨停1天的股票数 |
| 二板 | 连续涨停2天的股票数 |
| 三板 | 连续涨停3天的股票数 |
| 3板+ | 连续涨停3天及以上的股票数 |
| 最高板 | 当日最多连板天数 |

### 晋级率

**算法**：分子 = 昨日 N 板且今日再次涨停的只数；分母 = **昨日 N 板且今日有交易的只数**（今日停牌的不计入分母，避免拉低晋级率）。

| 指标 | 说明 | 计算公式 |
|------|------|----------|
| 1进2% | 昨日首板今日再次涨停的比例 | 昨日首板且今日涨停数 / 昨日首板且今日有交易数 × 100 |
| 2进3% | 昨日二板今日再次涨停的比例 | 昨日二板且今日涨停数 / 昨日二板且今日有交易数 × 100 |
| 3进4% | 昨日三板今日再次涨停的比例 | 昨日三板且今日涨停数 / 昨日三板且今日有交易数 × 100 |
| 3板+晋级% | 昨日四板及以上今日再次涨停的比例 | 昨日四板+且今日涨停数 / 昨日四板+且今日有交易数 × 100 |

### 高阶指标

| 指标 | 说明 |
|------|------|
| 反包涨停 | 最低价低于上日最低价但仍涨停的股票数 |
| 涨停金额 | 所有涨停股票的成交金额总和（亿元） |
| 封单金额 | 所有涨停股票的封单金额总和（亿元） |
| 涨5%/跌5% | 涨跌幅超过5%的股票数量 |

### 红盘率与溢价

| 指标 | 说明 |
|------|------|
| 红盘率 | 收盘价≥开盘价的股票占比（%） |
| 溢价 | 平均涨幅（%），反映市场强度 |

---

## 颜色标记规则

### 正面指标（红色背景）

- 晋级率 > 40%
- 红盘率 > 60%
- 溢价 > 3%

### 负面指标（绿色背景）

- 炸板率 > 40%
- 跌停数较多
- 晋级率 < 20%

可以在 `config.py` 中的 `COLOR_THRESHOLDS` 修改颜色规则。

---

## 文件结构

```
情绪周期表/
├── config.py              # 配置文件
├── data_fetcher.py        # 数据获取模块
├── indicators.py          # 指标计算模块
├── storage.py             # 数据存储模块
├── update_data.py         # 数据更新脚本
├── app.py                 # Flask Web服务
├── test_system.py         # 系统测试脚本
├── utils.py               # 工具函数
├── data/                  # 数据目录
│   ├── raw/              # 原始数据（Parquet）
│   └── processed/        # 处理后数据
├── static/                # 静态资源
│   ├── css/style.css
│   └── js/main.js
├── templates/             # HTML模板
│   └── index.html
└── README.md             # 项目说明
```

---

## 常见问题

### Q1: 数据更新失败怎么办？

**A:** 检查以下几点：
1. 网络连接是否正常
2. tushare token是否有效
3. 积分是否足够（需要5000+积分）
4. 是否在交易时间之外（收盘后15:30后数据才更新）

### Q2: 如何修改颜色标记规则？

**A:** 编辑 `config.py` 中的 `COLOR_THRESHOLDS` 配置：

```python
COLOR_THRESHOLDS = {
    'advance_1to2': {'good': 40, 'bad': 20},  # 晋级率阈值
    'break_rate': {'good': 20, 'bad': 40, 'reverse': True},  # 炸板率阈值
    # ... 更多配置
}
```

### Q3: 如何设置自动定时更新？

**A:** 使用Windows任务计划程序：

1. 打开"任务计划程序"
2. 创建基本任务
3. 触发器：每天15:35
4. 操作：启动程序
   - 程序：`python`
   - 参数：`update_data.py`
   - 起始位置：`D:\_TradeCode\复盘工具\情绪周期表`

### Q4: Web页面无法访问？

**A:** 确保Flask服务已启动：

```bash
python app.py
```

看到 "Running on http://127.0.0.1:5000" 后即可访问。

### Q5: 晋级率全是0%正常吗？

**A:** 如果是刚初始化数据，前几天的晋级率可能为0%或空值，因为：
- 第一天没有"昨日数据"可比较
- 市场确实没有连板晋级的情况

随着数据积累，晋级率会逐渐显示正常值。

---

## 性能优化

### 数据量较大时

1. **只加载最近数据**：在Web页面使用日期筛选
2. **定期清理旧数据**：保留最近1-2年数据即可
3. **使用Parquet分区存储**：按年份分区提升查询速度

### API调用优化

- 脚本已内置0.3秒延迟，避免触发限流
- 批量获取数据时自动按日期循环
- 如需更快速度，可调整 `config.py` 中的 `API_DELAY`

---

## 技术支持

### 测试系统

运行完整测试：

```bash
python test_system.py
```

### 查看日志

- Flask服务日志：启动时在控制台输出
- 数据更新日志：运行update_data.py时实时显示

### 常用命令

```bash
# 测试tushare连接
python data_fetcher.py

# 测试指标计算
python indicators.py

# 测试存储功能
python storage.py

# 完整系统测试
python test_system.py
```

---

## 更新日志

### v1.0.0 (2026-01-27)

- ✅ 初始版本发布
- ✅ 26个核心指标
- ✅ Web可视化界面
- ✅ Parquet存储
- ✅ 增量更新机制
- ✅ Excel导出功能

---

## 许可证

本项目仅供个人学习和研究使用。

**重要提示**：
- 数据来源于tushare，请遵守tushare使用协议
- 本工具不构成任何投资建议
- 投资有风险，决策需谨慎
